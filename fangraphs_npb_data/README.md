# Extract FanGraphs NPB Data

## 概要
- FanGraphsにあるNPBデータを抽出するためのものです。
- 本フォルダには以下のファイルがあります。
    - fg_npb_leaderboard.ipynb : リーダーボードから打撃成績データを取得（全選手対象）
    - fg_npb_player_detail.ipynb : リーダーボードから投手成績データを取得（全選手対象）
    - fg_npb_coeffs.ipynb : リーダーボードの値を元に、wOBA関連係数・球場補正の推測値を計算
    - fg_npb_team_wrcplus.ipynb : リーダーボードの値を元に、チーム別wRC+の推測値を計算
    - fg_npb_war_batrep.ipynb : リーダーボードの値を元に、選手別RAR・WARの推測値を計算（2025年度のみ対応）

## 処理内容
それぞれのファイルで実施している処理内容を説明します。
### 1. fg_npb_leaderboard.ipynb
- リーダーボードから開始年度・終了年度・成績区分を指定し、データを取得します。
#### 1-1. 取得対象
- 取得対象は単年度（single season）・複数年度（multiple seasons）の2つがあります。
    - 単年度（single season）
        - 各年度の単年度のデータを連続して取得します。
        - 例えば開始年度：2024年、終了年度：2025年を指定した場合、2024年のデータおよび2025年のデータをそれぞれ取得し、ひとつにまとめています。
        - 同一シーズン内で複数球団に所属した選手の成績を考慮するため、チーム毎に値を取得しています。そのため少々時間がかかります。
    - 複数年度（single season）
        - 開始年度・終了年度を指定し、その期間を通じたのデータを連続して取得します。
        - 例えば開始年度：2024年、終了年度：2025年を指定した場合、2024年から2025年までの合算データを取得しています。
#### 1-2. 指定内容
- それぞれの関数では、以下3点の引数を指定する必要があります。
    - start_year : 開始年度（4桁の数字で指定）
    - end_year : 終了年度（4桁の数字で指定）
    - stats_type : 成績区分（"bat"（打撃成績）あるいは"pit"（投手成績）のいずれかを指定）
> [!NOTE]  
> - 抽出対象データのうち、"Name"はタグの内容がそのまま取得されてしまうことから削除しています。
> - 抽出対象データに加え、"League"（所属リーグ）および"Position"（守備位置）のフィールドを追加しています。
>   - Positionの値は削除した"Name"の内容の一部から取得・格納しています。

### 2. fg_npb_player_detail.ipynb
- 各選手の詳細ページから打撃/投手成績および、守備成績のデータを取得します。
    - 野手の場合は打撃成績・守備成績、投手の場合は投手成績・守備成績を取得できます。

#### 2-1. 取得対象
- 取得対象はメイン成績（野手の場合は打撃成績、投手の場合は投手成績）・守備成績です。
    - メイン成績（打撃成績あるいは投手成績）
        - 各年度の打撃成績あるいは投手成績を取得します。
        - 野手を指定した場合は打撃成績が、投手を指定した場合は投手成績が自動で選択されます。
    - 守備成績
        - 各年度の守備成績を取得します。野手・投手共通です。
#### 2-2. 指定内容
- それぞれの関数では、以下3点の引数を指定する必要があります。
    - first_name : ファーストネーム（日本人の場合は名、小文字で指定）
    - last_name : ラストネーム（日本人の場合は姓、小文字で指定）
    - playerid : FanGraphsが定義している選手ID
        - 選手IDは画面から確認可能。なお、リーダーボードから抽出されたデータにも格納されています。
> [!NOTE]  
> - 抽出対象データのうち、"Season"および"Team"はタグの内容がそのまま取得されてしまうこと、また他のフィールドで代替可能なことから削除しています。
> - MLB経験のある選手の場合、FanGraphsのID（5桁）が振られています。左記選手を対象とする場合、そちらのIDを指定してください。
>   - なお、上記の場合NPB・MLBのデータが同一のデータフレームに格納されます。このため、NPBしか経験のない選手に比べてフィールド数が非常に多くなります。

### 3. fg_npb_coeffs.ipynb
- リーダーボードから取得した内容を元に、wOBA関連係数・球場補正の値（推測値）を計算しています。

#### 3-1. 計算内容
- 計算内容はwOBA関連係数・球場補正の2つがあります。
    - wOBA関連係数
        - リーダーボードの値を取得し、wOBAに関連する以下の推定値を年度別に計算しています。
            - 各イベントの係数（uBB, HBP, 1B, 2B, 3B HR）
            - リーグ平均R/PA（lgR_PA, 打席あたりの得点）
            - リーグ平均wOBA（wOBA, リーグ全体の故意四球抜き出塁率）
            - wOBAscale
            - リーグ平均wSB（lgwSB）
            - 盗塁・盗塁死の得点価値（runSB, runCS）
        - 計算値はNPB全体を対象とした値です。
    - 球場補正（Park Factor, PF）
        - リーダーボードの値を取得し、年度・チーム別の球場補正（推測値）を計算します。
#### 3-2. 指定内容
- それぞれの関数では、以下2点の引数を指定する必要があります。
    - start_year : 開始年度（4桁の数字で指定）
    - end_year : 終了年度（4桁の数字で指定）

> [!NOTE]  
> - wOBAの各イベント係数は、リーダーボードの選手別レコードから最小二乗法で推定した値です。
> - 球場補正は各選手のwRC+、球団別wRAA・wRC、セ・パ各リーグ別のwRC/PAから計算した値の加重平均です。
>   - このため、最新年度の値は日によって変動します。ご了承ください。
> - いずれも公式の値ではありませんので、あくまで参考程度にご利用ください。

### 4. fg_npb_team_wrcplus.ipynb
- リーダーボードから取得した内容を元に、年度・チーム別のwRC+（推測値）を計算しています。

#### 4-1. 計算内容
- リーダーボードの値を取得し、年度・チーム別のwRC（推測値）を計算しています。
    - wRC/PAの値はセ・パ各リーグ別の値（投手の打席を除く）を採用しています。
    - fg_npb_coeffs.ipynbと同様の方法で各チーム別の球場補正値を計算し、wRC+の計算に適用しています。
    - R/PAはNPB全体の値を採用しています。
#### 4-2. 指定内容
- それぞれの関数では、以下2点の引数を指定する必要があります。
    - start_year : 開始年度（4桁の数字で指定）
    - end_year : 終了年度（4桁の数字で指定）

> [!NOTE]
> - 球場補正は各選手のwRC+、球団別wRAA・wRC、セ・パ各リーグ別のwRC/PAから計算した値の加重平均です。
>   - このため、最新年度の値は日によって変動します。ご了承ください。
> - いずれも公式の値ではありませんので、あくまで参考程度にご利用ください。

### 5. fg_npb_war_batrep.ipynb
- リーダーボードから取得した内容を元に、選手別のRAR（Runs Above Replacement）およびWAR（Wins Above Replacement）の推測値を計算しています。
- **現時点では2025年度のみ対応しています。**

#### 5-1. 計算内容
- 計算内容は以下の通りです。
    - RAR_bat（打撃によるRAR）
        - wRAAに対し、リーグ平均打力との差分および球場補正を適用した値です。
    - RAR_rep（リプレイスメント補正）
        - 打席数に応じたリプレイスメントレベル補正です。
    - RAR_batrep（打撃RAR合計）
        - RAR_bat + RAR_repの合計値です。
    - WAR_batrep（打撃WAR）
        - RAR_batrepをRPW（Runs Per Win）で除した値です。
- RPWは総得点・イニング数から計算しています（コード内で固定値として定義）。
- 一部選手のデータが2倍カウントされている問題に対応するため、補正処理を含んでいます。

#### 5-2. 出力内容
- 選手別にSeason, Team, PlayerName, Position, RAR_bat, RAR_rep, RAR_batrep, WAR_batrepを出力します。
- おまけとして、チーム別WAR_batrep（投手除く）の横棒グラフを表示します。

> [!NOTE]
> - 本ノートブックは2025年度データのみを対象としています。複数年度対応は今後の課題です。
> - 守備・走塁・ポジション補正は含まれていません。打撃面のみの評価となります。
> - RPW計算に使用する総得点・イニング数はコード内で固定値として定義しています。
> - いずれも公式の値ではありませんので、あくまで参考程度にご利用ください。

## 利用言語・環境等
- 言語はPythonで記述しています。
- ファイルはJupyter Notebook形式（.ipynb）にて保存しています。
- FanGraphsのNPBデータは2019年度から存在しています。

## 使い方
- Google Colab等、Jupyter Notebookをご利用可能であれば、順次コードを実行するだけで結果を得ることができます（検証済）。
    - 動作不具合などあった場合はお知らせください。
- .pyファイルとして実行される際は、必要に応じて修正の上ご利用ください。